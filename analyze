#!/usr/local/bin/python3
"""
File: analyze (3.X)
Analyzes a server log file

analyze <analyzer> <file> <options>

Available analyzers:

  * Combined access log: `access/combined`

The following options are available:

  --daterange       Return only logs within the given range
                    Format: '%d/%b/%Y:%H:%M:%S %z,%d/%b/%Y:%H:%M:%S %z'
                    Example: '17/Sep/2017:03:32:49 -0400,17/Sep/2017:03:32:49 -0400'

  --ip              Return only logs with certain IPs. Comma separated list.
                    Format: 'IP' or 'IP,IP'

  --url             Return only logs that match a certain request url
                    Format: regular expression

  --useragent       Return only logs that match a certain user agent
                    Format: regular expression
"""

#
# ./analyze access/combined ~/Desktop/logs/hub-ssl.access --url=baltimore-food-deserts --daterange='23/Jan/2018:08:38:45 -0500,23/Jan/2018:08:38:59 -0500'
# ./analyze access/combined files/jhu-ssl.access --daterange='01/Jul/2018:03:23:16 -0400,01/Jul/2018:03:23:30 -0400'
# ./analyze access/combined files/jhu-ssl.access --ip=23.67.53.60
# ./analyze access/combined files/shortened-access.log --useragent=Chrome
# ./analyze access/combined files/shortened-access.log --useragent=Chrome

import sys
from parsers.argument import ArgumentParser


# dynamically load the parser
logparsers = {
  'access/combined': {
    'package': 'parsers.access.combined',
    'name': 'Combined'
  }
}
parser = logparsers.get(sys.argv[1])
LogParser = getattr(__import__(parser.get('package'), fromlist=[parser.get('name')]), parser.get('name'))


# parse the options
argparser = ArgumentParser(sys.argv[3:])
options = argparser.parse()


# parse logs
parser = LogParser(open(sys.argv[2], 'r'), options)
results = parser.parse()

# print results
for result in results:
  print(result)
